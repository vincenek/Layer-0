<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#101024">
    <title>Layer 0: Drift Alpha</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-indigo: #101024;
            --neural-grey: #1a1a2e;
            --soft-violet: #6c63ff;
            --glow-violet: rgba(108, 99, 255, 0.2);
            --breath-blue: #4fc3f7;
            --card-width: min(90vw, 380px);
            --transition-speed: 0.4s;
            --mobile-breakpoint: 768px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at center, var(--deep-indigo) 0%, #000000 100%);
            color: rgba(255, 255, 255, 0.85);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }

        #layer0 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            z-index: 1;
        }

        .ambient-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(108, 99, 255, 0.05) 0%, transparent 70%);
            opacity: 0.7;
            z-index: -1;
            animation: ambientPulse 15s infinite alternate;
        }

        .card {
            position: absolute;
            width: var(--card-width);
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(108, 99, 255, 0.3),
                        0 0 30px 5px var(--glow-violet);
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            overflow: hidden;
            border: 1px solid rgba(108, 99, 255, 0.1);
            animation: cardFloat 6s infinite alternate ease-in-out;
        }

        .card.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--soft-violet), var(--breath-blue));
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #ffffff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card p {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.75);
        }

        .card-content {
            padding: 10px 0;
        }

        .card-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            background: rgba(108, 99, 255, 0.15);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            font-size: 0.9rem;
            min-height: 48px;
        }

        .btn:hover {
            background: rgba(108, 99, 255, 0.25);
            transform: translateY(-2px);
        }

        .btn.primary {
            background: linear-gradient(45deg, var(--soft-violet), #7986ff);
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
        }

        .thought-input {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(108, 99, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: none;
            margin-bottom: 15px;
            outline: none;
            transition: border 0.3s ease;
        }

        .thought-input:focus {
            border: 1px solid var(--soft-violet);
        }

        .bubble-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .bubble {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neural-grey), var(--deep-indigo));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(108, 99, 255, 0.2),
                        inset 0 0 10px rgba(108, 99, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bubble:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(108, 99, 255, 0.4);
        }

        .bubble i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--soft-violet);
        }

        .bubble span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .breathing-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 30px auto;
            background: radial-gradient(circle, rgba(26, 26, 46, 0.8) 0%, rgba(16, 16, 36, 0.9) 70%);
            border: 2px solid rgba(108, 99, 255, 0.3);
            box-shadow: 0 0 30px rgba(108, 99, 255, 0.2),
                        inset 0 0 20px rgba(108, 99, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .breath-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(79, 195, 247, 0.15) 0%, transparent 70%);
            animation: breathPulse 8s infinite ease-in-out;
        }

        .breath-text {
            font-size: 1.5rem;
            font-weight: 500;
            z-index: 2;
            color: var(--breath-blue);
        }

        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            z-index: 5;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--soft-violet);
            box-shadow: 0 0 10px var(--soft-violet);
            animation: pulse 2s infinite;
        }

        .status-indicator.idle {
            background: #ff9800;
            box-shadow: 0 0 10px #ff9800;
        }

        .status-indicator.anxious {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
            animation: anxiousPulse 1.5s infinite;
        }

        .status-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .time-display {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            z-index: 5;
            text-align: right;
        }

        .welcome-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 500px;
            padding: 30px;
            z-index: 0;
            opacity: 0.6;
            width: 90%;
        }

        .welcome-message h1 {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffffff, var(--breath-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .welcome-message p {
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.6);
        }

        .gesture-hint {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            z-index: 2;
            animation: fadeHint 8s infinite;
        }

        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background: rgba(16, 16, 36, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 10px;
            z-index: 20;
            border-top: 1px solid rgba(108, 99, 255, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 1.4rem;
            color: var(--soft-violet);
        }

        .nav-item.active {
            color: white;
            transform: translateY(-5px);
        }

        .nav-item.active i {
            color: var(--breath-blue);
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .neuro-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at center, transparent 0%, rgba(16, 16, 36, 0.9) 100%),
                linear-gradient(rgba(108, 99, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(108, 99, 255, 0.1) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            background-position: center;
            z-index: -2;
            opacity: 0.3;
        }

        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 46, 0.95);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            border: 1px solid rgba(108, 99, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 0.9rem;
        }

        .notification.show {
            opacity: 1;
        }

        .timer-display {
            font-size: 2.5rem;
            text-align: center;
            margin: 20px 0;
            font-weight: 300;
            color: var(--breath-blue);
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .timer-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            background: rgba(108, 99, 255, 0.15);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .timer-btn:hover {
            background: rgba(108, 99, 255, 0.25);
        }

        .timer-btn.primary {
            background: linear-gradient(45deg, var(--soft-violet), #7986ff);
        }

        .meditation-container {
            margin: 20px 0;
            text-align: center;
        }

        .meditation-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--breath-blue);
            min-height: 60px;
        }

        .meditation-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .sound-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .sound-option {
            padding: 15px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(108, 99, 255, 0.2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-option:hover {
            border-color: var(--soft-violet);
            transform: translateY(-3px);
        }

        .sound-option i {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: block;
            color: var(--soft-violet);
        }

        .journal-prompt {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
            border-left: 3px solid var(--soft-violet);
        }

        .journal-textarea {
            width: 100%;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(108, 99, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: none;
            margin-bottom: 15px;
            outline: none;
            transition: border 0.3s ease;
        }

        .journal-textarea:focus {
            border: 1px solid var(--soft-violet);
        }

        /* Animations */
        @keyframes ambientPulse {
            0% { opacity: 0.4; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.05); }
        }

        @keyframes cardFloat {
            0% { transform: translateY(0) rotate(0.5deg); }
            100% { transform: translateY(-10px) rotate(-0.5deg); }
        }

        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.6; transform: scale(1); }
        }

        @keyframes anxiousPulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        @keyframes breathPulse {
            0% { transform: scale(0.8); opacity: 0.2; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.8); opacity: 0.2; }
        }

        @keyframes fadeHint {
            0% { opacity: 0; }
            30% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes breatheInOut {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0.8); }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            .card {
                padding: 20px;
                border-radius: 18px;
            }
            
            .card h2 {
                font-size: 1.3rem;
            }
            
            .card p {
                font-size: 0.9rem;
            }
            
            .btn {
                min-width: 100%;
                padding: 12px;
                margin-bottom: 8px;
            }
            
            .bubble {
                width: 70px;
                height: 70px;
            }
            
            .bubble i {
                font-size: 1.5rem;
            }
            
            .breathing-circle {
                width: 150px;
                height: 150px;
            }
            
            .status-bar, .time-display {
                top: 15px;
            }
            
            .time-display {
                font-size: 0.8rem;
            }
            
            .mobile-nav {
                padding: 12px 5px;
            }
            
            .nav-item {
                font-size: 0.7rem;
            }
            
            .nav-item i {
                font-size: 1.2rem;
            }
            
            .sound-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-height: 600px) {
            .welcome-message {
                top: 45%;
            }
            
            .gesture-hint {
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="layer0">
        <div class="ambient-bg"></div>
        <div class="neuro-grid"></div>
        
        <!-- Welcome Message -->
        <div class="welcome-message">
            <h1>Layer 0: Drift Alpha</h1>
            <p>The subconscious operating system that responds to your presence, behavior, and rhythm</p>
        </div>
        
        <!-- Status Indicators -->
        <div class="status-bar">
            <div class="status-indicator" id="activity-indicator"></div>
            <div class="status-text" id="status-text">Ambient</div>
        </div>
        
        <div class="time-display" id="time-display"></div>
        
        <div class="gesture-hint" id="gesture-hint">Touch and hold to access subconscious menu</div>
        
        <!-- Cards will be dynamically injected here -->
    </div>

    <div class="notification" id="notification"></div>

    <nav class="mobile-nav">
        <div class="nav-item active" id="nav-home">
            <i>🌌</i>
            <span>Home</span>
        </div>
        <div class="nav-item" id="nav-thoughts">
            <i>💭</i>
            <span>Thoughts</span>
        </div>
        <div class="nav-item" id="nav-mood">
            <i>😌</i>
            <span>Mood</span>
        </div>
        <div class="nav-item" id="nav-settings">
            <i>⚙️</i>
            <span>Settings</span>
        </div>
    </nav>

    <script>
        // Enhanced Card templates with interactive features
        const cardTemplates = {
            restMode: `
                <div class="card" id="rest-card">
                    <h2>🛌 Rest Mode</h2>
                    <p>You've been inactive for a while. Take a mindful break to recharge your mind.</p>
                    <div class="timer-display" id="timer-display">05:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" onclick="pauseResumeTimer()" id="timer-control">Start</button>
                        <button class="timer-btn primary" onclick="hideCard('rest-card')">Dismiss</button>
                    </div>
                </div>
            `,
            
            thoughtVault: `
                <div class="card" id="thought-card">
                    <h2>💭 Thought Vault</h2>
                    <p>You seemed to be in a flow. Capture your thoughts before they drift away...</p>
                    <textarea class="thought-input" placeholder="Type your thoughts here..." id="thought-input"></textarea>
                    <div class="card-actions">
                        <button class="btn" onclick="hideCard('thought-card')">Cancel</button>
                        <button class="btn primary" onclick="saveThought()">Save Thought</button>
                    </div>
                </div>
            `,
            
            focusBubble: `
                <div class="card" id="focus-card">
                    <h2>🌀 Focus Bubble</h2>
                    <p>Your scrolling suggests you might be searching for focus. Try one of these:</p>
                    <div class="bubble-container">
                        <div class="bubble" onclick="showMeditationCard()">
                            <i>🧘</i>
                            <span>Meditate</span>
                        </div>
                        <div class="bubble" onclick="showJournalCard()">
                            <i>📓</i>
                            <span>Journal</span>
                        </div>
                        <div class="bubble" onclick="showAmbientSounds()">
                            <i>🎧</i>
                            <span>Sounds</span>
                        </div>
                    </div>
                </div>
            `,
            
            anxietyMode: `
                <div class="card" id="anxiety-card">
                    <h2>🌬️ Calm Breath</h2>
                    <p>Your movements suggest restlessness. Follow your breath for a moment...</p>
                    <div class="breathing-circle" id="breathing-circle">
                        <div class="breath-animation" id="breath-animation"></div>
                        <div class="breath-text" id="breath-text">Breathe In</div>
                    </div>
                    <div class="card-actions">
                        <button class="btn" onclick="hideCard('anxiety-card')">I'm calm</button>
                        <button class="btn primary" onclick="startBreathingExercise()">Guide Me</button>
                    </div>
                </div>
            `,
            
            morningMode: `
                <div class="card" id="morning-card">
                    <h2>🌅 Mind Setup</h2>
                    <p>Good morning! How would you like to set the tone for your day?</p>
                    <div class="bubble-container">
                        <div class="bubble" onclick="setIntention()">
                            <i>🎯</i>
                            <span>Intention</span>
                        </div>
                        <div class="bubble" onclick="showGratitudeCard()">
                            <i>🙏</i>
                            <span>Gratitude</span>
                        </div>
                        <div class="bubble" onclick="showPlanCard()">
                            <i>📋</i>
                            <span>Plan</span>
                        </div>
                    </div>
                </div>
            `,
            
            nightMode: `
                <div class="card" id="night-card">
                    <h2>🌙 Close Loop</h2>
                    <p>As the day winds down, take a moment to reflect and release...</p>
                    <div class="bubble-container">
                        <div class="bubble" onclick="showReflectionCard()">
                            <i>🔄</i>
                            <span>Reflect</span>
                        </div>
                        <div class="bubble" onclick="showGratitudeCard()">
                            <i>💖</i>
                            <span>Gratitude</span>
                        </div>
                        <div class="bubble" onclick="setWindDown()">
                            <i>⏳</i>
                            <span>Wind Down</span>
                        </div>
                    </div>
                </div>
            `,
            
            aiPrompt: `
                <div class="card" id="ai-card">
                    <h2>🧠 Mind Check</h2>
                    <p id="ai-question">How are you feeling in this moment?</p>
                    <textarea class="thought-input" placeholder="Share your thoughts..." id="ai-response"></textarea>
                    <div class="card-actions">
                        <button class="btn" onclick="hideCard('ai-card')">Skip</button>
                        <button class="btn primary" onclick="saveAIResponse()">Save</button>
                    </div>
                </div>
            `,
            
            moodLog: `
                <div class="card" id="mood-card">
                    <h2>😌 Mood Log</h2>
                    <p>How are you feeling right now? Select your current state:</p>
                    <div class="bubble-container">
                        <div class="bubble" onclick="logMood('calm')">
                            <i>😌</i>
                            <span>Calm</span>
                        </div>
                        <div class="bubble" onclick="logMood('focused')">
                            <i>🧠</i>
                            <span>Focused</span>
                        </div>
                        <div class="bubble" onclick="logMood('energetic')">
                            <i>⚡</i>
                            <span>Energetic</span>
                        </div>
                        <div class="bubble" onclick="logMood('tired')">
                            <i>😴</i>
                            <span>Tired</span>
                        </div>
                    </div>
                </div>
            `,
            
            meditation: `
                <div class="card" id="meditation-card">
                    <h2>🧘 Mindful Moment</h2>
                    <p>Take a few minutes to center yourself with this guided meditation:</p>
                    <div class="meditation-container">
                        <div class="meditation-text" id="meditation-text">Find a comfortable position and close your eyes...</div>
                        <div class="meditation-controls">
                            <button class="btn" onclick="hideCard('meditation-card')">Exit</button>
                            <button class="btn primary" onclick="nextMeditationStep()" id="meditation-control">Begin</button>
                        </div>
                    </div>
                </div>
            `,
            
            journal: `
                <div class="card" id="journal-card">
                    <h2>📓 Journal Prompt</h2>
                    <p>Reflect on this thought:</p>
                    <div class="journal-prompt" id="journal-prompt">What are three things you're grateful for today?</div>
                    <textarea class="journal-textarea" placeholder="Write your thoughts here..." id="journal-entry"></textarea>
                    <div class="card-actions">
                        <button class="btn" onclick="hideCard('journal-card')">Cancel</button>
                        <button class="btn primary" onclick="saveJournalEntry()">Save Entry</button>
                    </div>
                </div>
            `,
            
            ambientSounds: `
                <div class="card" id="sounds-card">
                    <h2>🎧 Ambient Soundscape</h2>
                    <p>Select a sound to help you focus or relax:</p>
                    <div class="sound-options">
                        <div class="sound-option" onclick="playSound('rain')">
                            <i>🌧️</i>
                            <span>Rain</span>
                        </div>
                        <div class="sound-option" onclick="playSound('forest')">
                            <i>🌲</i>
                            <span>Forest</span>
                        </div>
                        <div class="sound-option" onclick="playSound('waves')">
                            <i>🌊</i>
                            <span>Waves</span>
                        </div>
                        <div class="sound-option" onclick="playSound('coffee')">
                            <i>☕</i>
                            <span>Coffee Shop</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn" onclick="stopAllSounds()">Stop Sounds</button>
                        <button class="btn" onclick="hideCard('sounds-card')">Close</button>
                    </div>
                </div>
            `
        };

        // Enhanced State management
        let state = {
            activeCard: null,
            idleTimer: null,
            typingTimer: null,
            lastTouchPosition: { x: 0, y: 0 },
            touchSpeed: 0,
            touchSpeeds: [],
            scrollSpeeds: [],
            lastScrollPosition: 0,
            lastScrollTime: 0,
            lastActivity: Date.now(),
            userStatus: 'ambient',
            isMobile: /Mobi|Android/i.test(navigator.userAgent),
            longPressTimer: null,
            timerInterval: null,
            timerRunning: false,
            timerSeconds: 300,
            meditationStep: 0,
            breathingPhase: 0,
            breathingInterval: null,
            activeSound: null
        };

        // DOM Elements
        const layer0 = document.getElementById('layer0');
        const activityIndicator = document.getElementById('activity-indicator');
        const statusText = document.getElementById('status-text');
        const timeDisplay = document.getElementById('time-display');
        const gestureHint = document.getElementById('gesture-hint');
        const notification = document.getElementById('notification');

        // Initialize
        function init() {
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 60000);
            
            // Set time-based card
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) {
                showCard('morningMode');
            } else if (hour >= 21 || hour < 5) {
                showCard('nightMode');
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Start idle detection
            resetIdleTimer();
            
            // Initialize mobile nav
            initMobileNav();
            
            // Hide gesture hint after delay
            setTimeout(() => {
                gestureHint.style.opacity = '0';
            }, 8000);
        }

        // Show notification
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize mobile navigation
        function initMobileNav() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    const id = this.id;
                    if (id === 'nav-thoughts') {
                        showCard('thoughtVault');
                    } else if (id === 'nav-mood') {
                        showCard('moodLog');
                    }
                });
            });
        }

        // Update time display
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
            timeDisplay.textContent = `${dateString}\n${timeString}`;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Mouse movement tracking
            document.addEventListener('mousemove', handleActivity);
            
            // Touch movement tracking
            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchmove', handleTouchMove);
            
            // Keyboard activity
            document.addEventListener('keydown', handleActivity);
            
            // Scroll activity
            document.addEventListener('scroll', handleScroll);
            
            // Long press for mobile
            document.addEventListener('touchstart', handleLongPressStart);
            document.addEventListener('touchend', handleLongPressEnd);
            
            // Click to clear hint
            document.addEventListener('click', () => {
                gestureHint.style.opacity = '0';
            });
        }

        // Touch start handler
        function handleTouchStart(e) {
            const touch = e.touches[0];
            state.lastTouchPosition = { x: touch.clientX, y: touch.clientY };
            state.lastActivity = Date.now();
            resetIdleTimer();
        }

        // Touch move handler
        function handleTouchMove(e) {
            const touch = e.touches[0];
            const now = Date.now();
            const timeDiff = now - state.lastActivity;
            
            const distance = Math.sqrt(
                Math.pow(touch.clientX - state.lastTouchPosition.x, 2) +
                Math.pow(touch.clientY - state.lastTouchPosition.y, 2)
            );
            
            state.touchSpeed = distance / timeDiff;
            state.touchSpeeds.push(state.touchSpeed);
            
            // Keep only the last 10 measurements
            if (state.touchSpeeds.length > 10) {
                state.touchSpeeds.shift();
            }
            
            // Detect erratic movement (anxiety)
            const avgSpeed = state.touchSpeeds.reduce((a, b) => a + b, 0) / state.touchSpeeds.length;
            const variance = state.touchSpeeds.reduce((a, b) => a + Math.pow(b - avgSpeed, 2), 0) / state.touchSpeeds.length;
            
            if (variance > 1 && avgSpeed > 0.5 && state.userStatus !== 'anxious') {
                setUserStatus('anxious');
                if (!state.activeCard) {
                    showCard('anxietyMode');
                }
            } else if (state.userStatus === 'anxious' && variance < 0.5 && avgSpeed < 0.3) {
                setUserStatus('ambient');
            }
            
            state.lastTouchPosition = { x: touch.clientX, y: touch.clientY };
            state.lastActivity = now;
        }

        // Handle activity (mouse and keyboard)
        function handleActivity() {
            resetIdleTimer();
        }

        // Long press handling for mobile
        function handleLongPressStart(e) {
            state.longPressTimer = setTimeout(() => {
                if (!state.activeCard) {
                    showCard('moodLog');
                }
            }, 800);
        }

        function handleLongPressEnd() {
            clearTimeout(state.longPressTimer);
        }

        // Scroll behavior detection
        function handleScroll() {
            const now = Date.now();
            const scrollPosition = window.scrollY || document.documentElement.scrollTop;
            
            if (state.lastScrollPosition !== 0) {
                const distance = Math.abs(scrollPosition - state.lastScrollPosition);
                const timeDiff = now - state.lastScrollTime;
                const speed = distance / timeDiff;
                
                state.scrollSpeeds.push(speed);
                
                // Keep only the last 5 measurements
                if (state.scrollSpeeds.length > 5) {
                    state.scrollSpeeds.shift();
                }
                
                // Detect fast scrolling followed by stop
                if (speed > 2 && state.scrollSpeeds.length > 2) {
                    setTimeout(() => {
                        const currentSpeed = state.scrollSpeeds[state.scrollSpeeds.length - 1];
                        if (currentSpeed < 0.1 && !state.activeCard) {
                            showCard('focusBubble');
                        }
                    }, 1000);
                }
            }
            
            state.lastScrollPosition = scrollPosition;
            state.lastScrollTime = now;
            resetIdleTimer();
        }

        // Idle detection
        function resetIdleTimer() {
            clearTimeout(state.idleTimer);
            state.idleTimer = setTimeout(() => {
                if (!state.activeCard) {
                    showCard('restMode');
                }
                setUserStatus('idle');
            }, 30000);
            
            setUserStatus('ambient');
            state.lastActivity = Date.now();
        }

        // Set user status
        function setUserStatus(status) {
            state.userStatus = status;
            activityIndicator.className = 'status-indicator ' + status;
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        // Card management
        function showCard(cardType) {
            // Hide any existing card
            if (state.activeCard) {
                hideCard(state.activeCard);
            }
            
            // Create new card
            const cardHTML = cardTemplates[cardType];
            layer0.insertAdjacentHTML('beforeend', cardHTML);
            
            // Get reference to the new card
            const cardId = cardType.replace('Mode', '').toLowerCase() + '-card';
            const card = document.getElementById(cardId);
            state.activeCard = cardId;
            
            // Animate in
            setTimeout(() => {
                card.classList.add('visible');
            }, 10);
            
            // Special setup for certain cards
            if (cardType === 'restMode') {
                state.timerSeconds = 300;
                updateTimerDisplay();
            }
            
            // AI prompt after 2 minutes of no interaction
            if (cardType !== 'aiPrompt') {
                setTimeout(() => {
                    if (state.activeCard === cardId) {
                        showAIPrompt();
                    }
                }, 120000);
            }
        }

        function hideCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.remove('visible');
                setTimeout(() => {
                    card.remove();
                    state.activeCard = null;
                    
                    // Clean up any ongoing processes
                    if (cardId === 'rest-card') {
                        clearInterval(state.timerInterval);
                        state.timerRunning = false;
                    }
                    if (cardId === 'anxiety-card') {
                        clearInterval(state.breathingInterval);
                    }
                }, 400);
            }
        }

        // Show AI prompt
        function showAIPrompt() {
            if (state.activeCard) return;
            
            const prompts = [
                "How are you feeling right now?",
                "What's occupying your mind at this moment?",
                "Is there something you need to get off your chest?",
                "What are you grateful for today?",
                "What would make today meaningful for you?"
            ];
            
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            
            // Create card
            layer0.insertAdjacentHTML('beforeend', cardTemplates.aiPrompt);
            document.getElementById('ai-question').textContent = randomPrompt;
            
            const card = document.getElementById('ai-card');
            state.activeCard = 'ai-card';
            
            // Animate in
            setTimeout(() => {
                card.classList.add('visible');
            }, 10);
        }

        // Timer functions
        function updateTimerDisplay() {
            const minutes = Math.floor(state.timerSeconds / 60);
            const seconds = state.timerSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            state.timerRunning = true;
            document.getElementById('timer-control').textContent = 'Pause';
            
            state.timerInterval = setInterval(() => {
                state.timerSeconds--;
                updateTimerDisplay();
                
                if (state.timerSeconds <= 0) {
                    clearInterval(state.timerInterval);
                    showNotification("Break completed! Time to return to your activities");
                    document.getElementById('timer-control').textContent = 'Restart';
                    state.timerRunning = false;
                }
            }, 1000);
        }

        function pauseResumeTimer() {
            if (!state.timerRunning) {
                startTimer();
            } else {
                clearInterval(state.timerInterval);
                state.timerRunning = false;
                document.getElementById('timer-control').textContent = 'Resume';
            }
        }

        // Save thought to localStorage
        function saveThought() {
            const thought = document.getElementById('thought-input').value;
            if (thought.trim()) {
                const thoughts = JSON.parse(localStorage.getItem('thoughts') || '[]');
                thoughts.push({
                    text: thought,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('thoughts', JSON.stringify(thoughts));
                showNotification('Thought saved to your vault!');
                hideCard('thought-card');
            } else {
                showNotification('Please enter your thoughts before saving');
            }
        }

        // Save AI response
        function saveAIResponse() {
            const response = document.querySelector('#ai-card .thought-input').value;
            if (response.trim()) {
                const responses = JSON.parse(localStorage.getItem('aiResponses') || '[]');
                responses.push({
                    response: response,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('aiResponses', JSON.stringify(responses));
                showNotification('Reflection saved successfully');
            }
            hideCard('ai-card');
        }

        // Start breathing exercise
        function startBreathingExercise() {
            const breathText = document.getElementById('breath-text');
            const breathAnimation = document.getElementById('breath-animation');
            
            breathText.textContent = "Breathe In";
            breathAnimation.style.animation = "breatheInOut 4s infinite ease-in-out";
            
            state.breathingPhase = 0;
            state.breathingInterval = setInterval(() => {
                state.breathingPhase = (state.breathingPhase + 1) % 2;
                if (state.breathingPhase === 0) {
                    breathText.textContent = "Breathe In";
                } else {
                    breathText.textContent = "Breathe Out";
                }
            }, 4000);
            
            document.querySelector('#anxiety-card .btn.primary').textContent = "Stop Guidance";
            document.querySelector('#anxiety-card .btn.primary').onclick = stopBreathingExercise;
        }

        function stopBreathingExercise() {
            clearInterval(state.breathingInterval);
            document.getElementById('breath-animation').style.animation = "none";
            document.querySelector('#anxiety-card .btn.primary').textContent = "Guide Me";
            document.querySelector('#anxiety-card .btn.primary').onclick = startBreathingExercise;
            document.getElementById('breath-text').textContent = "Breathe";
        }

        // Mood logging
        function logMood(mood) {
            const moods = JSON.parse(localStorage.getItem('moods') || '[]');
            moods.push({
                mood: mood,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('moods', JSON.stringify(moods));
            
            const moodEmoji = {
                'calm': '😌',
                'focused': '🧠',
                'energetic': '⚡',
                'tired': '😴'
            }[mood];
            
            showNotification(`Mood logged: ${moodEmoji}`);
            hideCard('mood-card');
        }

        // Meditation functions
        function showMeditationCard() {
            hideCard('focus-card');
            showCard('meditation');
        }

        const meditationSteps = [
            "Find a comfortable position and close your eyes...",
            "Take a deep breath in... and slowly exhale...",
            "Notice the sensations in your body...",
            "Observe your thoughts without judgment...",
            "Bring your attention to your breath...",
            "Gently return your awareness to the room..."
        ];

        function nextMeditationStep() {
            state.meditationStep++;
            
            if (state.meditationStep < meditationSteps.length) {
                document.getElementById('meditation-text').textContent = meditationSteps[state.meditationStep];
                document.getElementById('meditation-control').textContent = "Next";
            } else {
                showNotification("Meditation completed. Well done!");
                hideCard('meditation-card');
                state.meditationStep = 0;
            }
        }

        // Journal functions
        function showJournalCard() {
            hideCard('focus-card');
            showCard('journal');
            
            const prompts = [
                "What are three things you're grateful for today?",
                "Describe a meaningful moment from your day",
                "What challenge did you overcome today?",
                "What are you looking forward to tomorrow?",
                "What lesson did today teach you?"
            ];
            
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('journal-prompt').textContent = randomPrompt;
        }

        function saveJournalEntry() {
            const entry = document.getElementById('journal-entry').value;
            if (entry.trim()) {
                const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                entries.push({
                    prompt: document.getElementById('journal-prompt').textContent,
                    entry: entry,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('journalEntries', JSON.stringify(entries));
                showNotification('Journal entry saved successfully');
                hideCard('journal-card');
            } else {
                showNotification('Please write something before saving');
            }
        }

        // Ambient sounds
        function showAmbientSounds() {
            hideCard('focus-card');
            showCard('ambientSounds');
        }

        function playSound(type) {
            // In a real implementation, we would play actual sounds
            const soundNames = {
                'rain': 'Gentle Rain',
                'forest': 'Forest Ambience',
                'waves': 'Ocean Waves',
                'coffee': 'Coffee Shop'
            };
            
            showNotification(`Playing: ${soundNames[type]}`);
            state.activeSound = type;
        }

        function stopAllSounds() {
            if (state.activeSound) {
                showNotification('Sounds stopped');
                state.activeSound = null;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration);
                    }).catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>